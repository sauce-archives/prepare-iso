This tool will create a disk image for OS X, given the downloaded installer OS .app (or the InstallESD.dmg inside the .app). Once built, the new disk image can be used along with packer to create a bootable disk image. Hooray!

The `-l` flag (described below) should be chosen based on the intended environment, either VirtualBox or QEMU.

All builds should run locally, even for QEMU - just transfer the finished image over to vmbuilder, etc.

# Getting Started

First, we need a copy of the Sierra app. You might already have it - check the location below. If not, it's easiest to download a copy from the App store (unfortunately). Link: https://itunes.apple.com/us/app/macos-sierra/id1127487414?mt=12

The file will be located here:
```
/Applications/Install macOS Sierra.app
```

# Building the Image

Now use `prepare_iso.sh` with the downloaded Sierra app by running:
```
sudo prepare_iso/prepare_iso.sh -D DISABLE_REMOTE_MANAGEMENT -D DISABLE_SCREEN_SHARING -D DISABLE_SIP -l <SPUD|GPTSPUD> "/Applications/Install macOS Sierra.app" ~/iso
```

About the command:
- `-D` flags are all necessary.
- `-l` flag is the partition layout. Use `SPUD` for VirtualBox, `GPTSPUD` for QEMU.
- First parameter after the flags is the location of either the Sierra app, or the path to `InstallESD.dmg` inside the app (`/Applications/Install macOS Sierra.app/Contents/SharedSupport/InstallESD.dmg`).
- Second parameter is the output directory for the newly built image.

The command will finish with output like this (ignore the error - the tool isn't expecting the .dmg.cdr extension for some reason):
```
created: /Users/allison/iso/OSX_InstallESD_10.12_16A323.dmg.cdr
-- Fixing permissions..
-- Checksumming output image..
md5: /Users/allison/iso/OSX_InstallESD_10.12_16A323.dmg: No such file or directory
```

# Next Steps

Now you're ready to do a `rake build` in the [chef-osx12-base repo](https://github.com/saucelabs-images/chef-osx12-base). Be sure to set `ISO_PATH` to the location of the image produced by `prepare_iso.sh`.

### For VirtualBox

Example command:
```
bundle exec rake build BUILDER=virtualbox-iso ISO_PATH=~/iso/OSX_InstallESD_10.12_16A323.dmg.cdr
```

This will probably take about 20-30 minutes locally.

Afterward, you can load the image in VirtualBox using a command like this:
```
VBoxManage import output-virtualbox-iso/packer-virtualbox-iso-1478286404.ovf --vsys 0 --vmname sierra
```

Be sure to use the path of the `.ovf` generated by `rake build`.

### For QEMU

After the `.dmg.cdr` image is built and you've transferred it to vmbuilder, do a `rake build` like this:

```
bundle exec rake build BUILDER=qemu ISO_PATH=~/OSX_InstallESD_10.12_16A323.dmg.cdr
```

When finished, you can launch the VM using:
```
bundle exec rake start BUILDER=qemu
```

You could also use a modified libvirt XML template to define the Sierra VM and launch it.